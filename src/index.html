<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <title>PlagiUM</title>
    <style>
        .ip-highlight {
            color: white;
            background-color: green;
        }
    </style>
    <script>
        function handleFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        const ipsByUser = {};
                        data[0].forEach(record => {
                            if (!ipsByUser[record.nomcompletdelutilisateur]) {
                                ipsByUser[record.nomcompletdelutilisateur] = {};
                            }
                            if (!ipsByUser[record.nomcompletdelutilisateur][record.adresseip]) {
                                ipsByUser[record.nomcompletdelutilisateur][record.adresseip] = record.heure;
                            }
                        });
                        displayTable(ipsByUser);
                    } catch (e) {
                        console.error('Le fichier déposé n\'est pas un JSON valide :', e);
                    }
                };
                reader.readAsText(file);
            } else {
                console.log('Aucun fichier sélectionné');
            }
        }

        function displayTable(ipsByUser) {
            const table = document.getElementById('resultTable');
            table.innerHTML = '';
            const headerRow = document.createElement('tr');
            const nameHeader = document.createElement('th');
            nameHeader.textContent = 'Nom complet de l\'utilisateur';
            const ipHeader = document.createElement('th');
            ipHeader.textContent = 'Adresses IP uniques';
            headerRow.appendChild(nameHeader);
            headerRow.appendChild(ipHeader);
            table.appendChild(headerRow);
            for (const user in ipsByUser) {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = user;
                const ipCell = document.createElement('td');
                const ips = Object.keys(ipsByUser[user]);
                ips.forEach((ip, index) => {
                    const span = document.createElement('span');
                    span.textContent = ip;
                    if (ip.startsWith('10.') || ip.startsWith('132.204')) {
                        span.classList.add('ip-highlight');
                    }
                    span.setAttribute('data-toggle', 'tooltip');
                    span.setAttribute('title', ipsByUser[user][ip]);
                    ipCell.appendChild(span);
                    if (index < ips.length - 1) {
                        ipCell.appendChild(document.createTextNode(', '));
                    }
                });
                row.appendChild(nameCell);
                row.appendChild(ipCell);
                table.appendChild(row);
            }
            document.getElementById('resultat').classList.remove('d-none');
            $('[data-toggle="tooltip"]').tooltip();
        }
    </script>
</head>
<body>
    <div class="container-fluid">
        <h1>PlagiUM</h1>
        <div class="border border-primary rounded" style="padding: 2em;">
            <div class="form-group">
                <label for="fileInput">Déposez un fichier JSON :</label>
                <input type="file" id="fileInput" accept=".json" class="form-control">
            </div>
            <button onclick="handleFile()" class="btn btn-primary">Traiter le fichier</button>
        </div>
        <div id="resultat" class="d-none" style="margin-top: 2em;">
            <h2>Résultat de l'analyse</h2>
            <table id="resultTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Adresses IP uniques</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</body>
</html>